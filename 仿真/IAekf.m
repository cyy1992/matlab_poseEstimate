function [A_k,H_k,x,x_pre,P,P_pre,K,qNk,detNk,rNk,tNk,Q,R] = IAekf(f,x,P,h,z,Q,R,qNk,detNk,rNk,tNk,N)
m = size(P,1);L  =size(z,1);
t = 0.05; kx = 816.96026;ky = 811.69309;
temp_Ak =  [1,t;0,1];
A_k = blkdiag(temp_Ak,temp_Ak,temp_Ak,temp_Ak,temp_Ak,temp_Ak);
x_pre = f(x);
P_pre = A_k*P*A_k'+Q;
% H_k=[ kx1/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                          0, 0, -(kx1*(x_pre(1) + 25*cos(x_pre(7))*cos(x_pre(9)) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx1*(25*cos(x_pre(9))*sin(x_pre(7)) - 25*cos(x_pre(7))*cos(x_pre(11)) + 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0, - (kx1*(25*cos(x_pre(7))*sin(x_pre(9)) - 25*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))) - (kx1*(25*cos(x_pre(9)) + 25*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + 25*cos(x_pre(7))*cos(x_pre(9)) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (25*kx1*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + 25*cos(x_pre(7))*cos(x_pre(9)) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx1*(25*sin(x_pre(7))*sin(x_pre(11)) - 25*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0;
%                                           0, 0, ky1/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky1*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*cos(x_pre(9))*sin(x_pre(7)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky1*(25*cos(x_pre(7))*cos(x_pre(9)) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,   (ky1*(25*sin(x_pre(7))*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))) - (ky1*(25*cos(x_pre(9)) + 25*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*cos(x_pre(9))*sin(x_pre(7)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (25*ky1*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*cos(x_pre(9))*sin(x_pre(7)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky1*(25*cos(x_pre(7))*sin(x_pre(11)) + 25*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + 25*sin(x_pre(9)) - 25*cos(x_pre(9))*sin(x_pre(11))), 0;
%               kx1/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                          0, 0,                                   -(kx1*(x_pre(1) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0,                                    (kx1*(25*cos(x_pre(7))*cos(x_pre(11)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                                                                        (25*kx1*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11)))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))) - (25*kx1*sin(x_pre(9))*sin(x_pre(11))*(x_pre(1) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0,                                                (25*kx1*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + 25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx1*(25*sin(x_pre(7))*sin(x_pre(11)) - 25*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0;
%                                           0, 0,              ky1/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                   -(ky1*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2, 0,                                   -(ky1*(25*cos(x_pre(11))*sin(x_pre(7)) + 25*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                                                                      - (25*ky1*sin(x_pre(9))*sin(x_pre(11))*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2 - (25*ky1*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11)))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0,                                                (25*ky1*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) + 25*cos(x_pre(7))*cos(x_pre(11)) - 25*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky1*(25*cos(x_pre(7))*sin(x_pre(11)) + 25*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) - 25*cos(x_pre(9))*sin(x_pre(11))), 0;
%                                      kx1/x_pre(5), 0,                                          0, 0,                                                                                                              -(kx1*x_pre(1))/x_pre(5)^2, 0,                                                                                                                    0, 0,                                                                                                                                                                                                                                                               0, 0,                                                                                                                                                                                                                                              0, 0;
%                                           0, 0,                                     ky1/x_pre(5), 0,                                                                                                              -(ky1*x_pre(3))/x_pre(5)^2, 0,                                                                                                                    0, 0,                                                                                                                                                                                                                                                               0, 0,                                                                                                                                                                                                                                              0, 0;
%                       kx1/(x_pre(5) + 25*sin(x_pre(9))), 0,                                          0, 0,                                                                        -(kx1*(x_pre(1) + 25*cos(x_pre(7))*cos(x_pre(9))))/(x_pre(5) + 25*sin(x_pre(9)))^2, 0,                                                                          -(25*kx1*cos(x_pre(9))*sin(x_pre(7)))/(x_pre(5) + 25*sin(x_pre(9))), 0,                                                                                                                                                   - (25*kx1*cos(x_pre(9))*(x_pre(1) + 25*cos(x_pre(7))*cos(x_pre(9))))/(x_pre(5) + 25*sin(x_pre(9)))^2 - (25*kx1*cos(x_pre(7))*sin(x_pre(9)))/(x_pre(5) + 25*sin(x_pre(9))), 0,                                                                                                                                                                                                                                              0, 0;
%                                           0, 0,                      ky1/(x_pre(5) + 25*sin(x_pre(9))), 0,                                                                        -(ky1*(x_pre(3) - 25*cos(x_pre(9))*sin(x_pre(7))))/(x_pre(5) + 25*sin(x_pre(9)))^2, 0,                                                                          -(25*ky1*cos(x_pre(7))*cos(x_pre(9)))/(x_pre(5) + 25*sin(x_pre(9))), 0,                                                                                                                                                     (25*ky1*sin(x_pre(7))*sin(x_pre(9)))/(x_pre(5) + 25*sin(x_pre(9))) - (25*ky1*cos(x_pre(9))*(x_pre(3) - 25*cos(x_pre(9))*sin(x_pre(7))))/(x_pre(5) + 25*sin(x_pre(9)))^2, 0,                                                                                                                                                                                                                                              0, 0];



persistent qlast rlast;
if isempty(qlast)
    qlast = zeros(m,1);
end
if isempty(rlast)
    rlast = zeros(L,1);
end
nq = size(qNk,2);
nr = size(rNk,2);

rbal = zeros(L,1);

Temp = zeros(L,L);
Rk = R;flag = 1;
x_kpk = x_pre;

    H_k = [ -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(21*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
                                              0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0;
            kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0;
                                              0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 21*cos(x_pre(11))*sin(x_pre(7)) + 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (21*ky*cos(x_pre(9))*cos(x_pre(11))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
            kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0;
                                              0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 46*cos(x_pre(11))*sin(x_pre(7)) + 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (46*ky*cos(x_pre(9))*cos(x_pre(11))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
            -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(46*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
                                              0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0];
    z_kpre = h(x_kpk);
    r = z - z_kpre;
    Temp = H_k*P_pre*H_k';
    rbal = rlast + 1/N*(r - rNk(:,nr-N+1));
    Rk = R+1/(N-1)*((r-rbal)*(r-rbal)'-(rNk(:,nr-N+1)-rbal)*(rNk(:,nr-N+1)-rbal)'+1/N*(r - rNk(:,nr-N+1))*(r - rNk(:,nr-N+1))'+(N-1)/N*(tNk((L*(nr-1)+1):(L*nr),1:L)-Temp));
    Kk = P_pre*H_k'/(Rk+H_k*P_pre*H_k');
    z_kpre = h(x_kpk);
    x_k = x_kpk + Kk*(z-z_kpre);  
% while (x_k-x_pre)'*(x_k-x_pre)>10
for jj=1:20
    x_pre = x_k;
    H_k = [ -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(21*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
                                              0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0;
            kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0;
                                              0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 21*cos(x_pre(11))*sin(x_pre(7)) + 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (21*ky*cos(x_pre(9))*cos(x_pre(11))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
            kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0;
                                              0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 46*cos(x_pre(11))*sin(x_pre(7)) + 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (46*ky*cos(x_pre(9))*cos(x_pre(11))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
            -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(46*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
                                              0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0];
    z_kpre = h(x_k);
    r = z - z_kpre;
    Temp = H_k*P_pre*H_k';
    rbal = rlast + 1/N*(r - rNk(:,nr-N+1));
    Rk = R+1/(N-1)*((r-rbal)*(r-rbal)'-(rNk(:,nr-N+1)-rbal)*(rNk(:,nr-N+1)-rbal)'+1/N*(r - rNk(:,nr-N+1))*(r - rNk(:,nr-N+1))'+(N-1)/N*(tNk((L*(nr-1)+1):(L*nr),1:L)-Temp));
    Kk = P_pre*H_k'/(Rk+H_k*P_pre*H_k');
    x_k = x_k + Kk*(z-z_kpre);
    
end
% for jj = 1:3
%     x_kpk = x_k;
%     H_k = [ -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(21*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
%                                               0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 21*cos(x_pre(9))*sin(x_pre(11))), 0;
%             kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(21*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (21*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 21*cos(x_pre(11))*sin(x_pre(7)) - 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(21*sin(x_pre(7))*sin(x_pre(11)) + 21*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0;
%                                               0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 21*cos(x_pre(11))*sin(x_pre(7)) + 21*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 21*sin(x_pre(9))*sin(x_pre(11)))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(21*cos(x_pre(7))*sin(x_pre(11)) - 21*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11))) - (21*ky*cos(x_pre(9))*cos(x_pre(11))*(21*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 21*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 21*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
%             kx/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0,  (kx*(46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (kx*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) - (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0;
%                                               0, 0,  ky/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0,  (ky*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 - 46*cos(x_pre(11))*sin(x_pre(7)) + 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 + 46*sin(x_pre(9))*sin(x_pre(11)))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11))) - (46*ky*cos(x_pre(9))*cos(x_pre(11))*(46*cos(x_pre(7))*cos(x_pre(11)) - x_pre(3) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/(x_pre(5) + (25*sin(x_pre(9)))/2 - 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
%             -kx/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0,                                              0, 0, -(kx*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(kx*(46*cos(x_pre(7))*cos(x_pre(11)) - (25*cos(x_pre(9))*sin(x_pre(7)))/2 + 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (kx*((25*cos(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(7))*cos(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (kx*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (kx*(46*sin(x_pre(7))*sin(x_pre(11)) + 46*cos(x_pre(7))*cos(x_pre(11))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (46*kx*cos(x_pre(9))*cos(x_pre(11))*(x_pre(1) + (25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0;
%                                               0, 0, -ky/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, -(ky*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, -(ky*((25*cos(x_pre(7))*cos(x_pre(9)))/2 + 46*cos(x_pre(11))*sin(x_pre(7)) - 46*cos(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0, (ky*((25*sin(x_pre(7))*sin(x_pre(9)))/2 + 46*cos(x_pre(9))*sin(x_pre(7))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))) + (ky*((25*cos(x_pre(9)))/2 - 46*sin(x_pre(9))*sin(x_pre(11)))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2, 0, (46*ky*cos(x_pre(9))*cos(x_pre(11))*(x_pre(3) - 46*cos(x_pre(7))*cos(x_pre(11)) + (25*cos(x_pre(9))*sin(x_pre(7)))/2 - 46*sin(x_pre(7))*sin(x_pre(9))*sin(x_pre(11))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11)))^2 - (ky*(46*cos(x_pre(7))*sin(x_pre(11)) - 46*cos(x_pre(11))*sin(x_pre(7))*sin(x_pre(9))))/((25*sin(x_pre(9)))/2 - x_pre(5) + 46*cos(x_pre(9))*sin(x_pre(11))), 0];
% 
%     r = z - z_kpre;
%     Temp = H_k*P_pre*H_k';
%     rbal = rlast + 1/N*(r - rNk(:,nr-N+1));
%     Rk = R+1/(N-1)*((r-rbal)*(r-rbal)'-(rNk(:,nr-N+1)-rbal)*(rNk(:,nr-N+1)-rbal)'+1/N*(r - rNk(:,nr-N+1))*(r - rNk(:,nr-N+1))'+(N-1)/N*(tNk((L*(nr-1)+1):(L*nr),1:L)-Temp));
%     Kk = P_pre*H_k'/(Rk+H_k*P_pre*H_k');
%     z_kpre = h(x_kpk);
%     x_k = x_kpk + Kk*(z-z_kpre);
% end

rlast = rbal;
rNk(:,nr+1) = rbal;
tNk = [tNk;Temp];
det = A_k*P*A_k';
K = Kk;

x = x_k;
P = P_pre-K*H_k*P_pre;
det = det-P;
q = x-x_pre;
qNk(:,nq+1) = q;
qbal = qlast + 1/N*(q - qNk(:,nq-N+1));

Q = Q+1/(N-1)*((q-qbal)*(q-qbal)'-(qNk(:,nq-N+1)-qbal)*(qNk(:,nq-N+1)-qbal)'+1/N*(q - qNk(:,nq-N+1))*(q - qNk(:,nq-N+1))'+(N-1)/N*(detNk((m*(nq-1)+1):(m*nq),1:m)-det));
detNk = [detNk;det];
qlast = qbal;
R = Rk;